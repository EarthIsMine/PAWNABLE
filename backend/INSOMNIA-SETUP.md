# Insomnia Setup Guide for PAWNABLE API

## Quick Start

### 1. Import Insomnia Collection

1. Open Insomnia
2. Click **Import/Export** > **Import Data** > **From File**
3. Select `insomnia-collection.json` from this directory
4. The collection "PAWNABLE API" will be imported with all endpoints

### 2. Generate Test User Credentials

Run the seed script to create 2 test users in the database with pre-generated authentication signatures:

```bash
# If using pnpm (recommended)
pnpm --filter @pawnable/backend seed:test-users

# If using npm
npm run seed:test-users
```

This will output JSON data that you need to copy into Insomnia's environment.

### 3. Update Insomnia Environment

1. In Insomnia, click on the environment dropdown (usually shows "No Environment")
2. Click **Manage Environments**
3. Select **Base Environment**
4. Copy the JSON output from step 2 and paste it into the environment
5. Click **Done**

### 4. Test Login

Now you can instantly test the API:

1. Navigate to **üîê Authentication** folder
2. Click **2a. Login - Test User 1 (Auto)**
3. Click **Send**
4. You should get a successful response with a JWT token!

## Test Users

The seed script creates 2 test users with Hardhat's default accounts:

### Test User 1
- **User ID**: `test-user-001`
- **Wallet**: `0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266`
- **Private Key**: `0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80`
- **Email**: `testuser1@pawnable.test`

### Test User 2
- **User ID**: `test-user-002`
- **Wallet**: `0x70997970C51812dc3A010C7d01b50e0d17dc79C8`
- **Private Key**: `0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d`
- **Email**: `testuser2@pawnable.test`

‚ö†Ô∏è **NEVER use these private keys on mainnet!** They are publicly known Hardhat test accounts.

## Available Endpoints

### ÔøΩÔøΩ Basic
- Health Check
- API Info

### üîê Authentication
- **1. Get Auth Message** - Generate a message to sign
- **2a. Login - Test User 1 (Auto)** - Quick login with pre-generated signature (valid for 1 hour)
- **2b. Login - Test User 2 (Auto)** - Quick login with pre-generated signature (valid for 1 hour)
- **2c. Login (Manual)** - Custom login flow
- **3. Verify Token** - Check if JWT token is valid

### üë§ Users
- Get All Users
- Get My Info
- Get User by ID
- Get User by Wallet (Public)
- Create User
- Update User

### üíé Assets
- Get All Assets (Public)
- Get Asset by ID (Public)
- Get Assets by Blockchain (Public)
- Create Asset (Admin)
- Create ETH Asset (Admin)

### üí∞ Loans
- Get Marketplace (Public)
- Get All Loans
- Get Loan by ID
- Get Loans by Borrower
- Get Loans by Lender
- Create Loan
- Match Loan
- Activate Loan
- Repay Loan
- Liquidate Loan
- Cancel Loan

## Environment Variables

The Insomnia collection uses these variables:

### Server Config
- `base_url` - Base server URL
- `api_url` - API base URL

### Test User 1 Variables
- `test_user_1_id` - User ID
- `test_user_1_wallet` - Wallet address
- `test_user_1_private_key` - Private key
- `test_user_1_token` - JWT token (auto-generated)
- `test_user_1_message` - Auth message (auto-generated, expires in 5 min)
- `test_user_1_timestamp` - Message timestamp (auto-generated)
- `test_user_1_signature` - Wallet signature (auto-generated)

### Test User 2 Variables
- `test_user_2_id` - User ID
- `test_user_2_wallet` - Wallet address
- `test_user_2_private_key` - Private key
- `test_user_2_token` - JWT token (auto-generated)
- `test_user_2_message` - Auth message (auto-generated, expires in 5 min)
- `test_user_2_timestamp` - Message timestamp (auto-generated)
- `test_user_2_signature` - Wallet signature (auto-generated)

### Default Variables (for convenience)
- `user_id` - Defaults to test-user-001
- `wallet_address` - Defaults to test user 1's wallet
- `token` - Defaults to test user 1's token
- `loan_id` - Placeholder for loan operations
- `asset_id` - Placeholder for asset operations

## Signature Expiration

The authentication signatures generated by `npm run seed:test-users` are **valid for 60 minutes (1 hour)**.

If you get an error like:
```json
{
  "success": false,
  "error": "Authentication request expired. Please try again."
}
```

Simply run the seed script again:
```bash
# If using pnpm
pnpm --filter @pawnable/backend seed:test-users

# If using npm
npm run seed:test-users
```

Then update your Insomnia environment with the new values.

## JWT Token Expiration

JWT tokens are valid for **7 days**. After that, you'll need to login again.

## Switching Between Test Users

To switch between test users:

### Option 1: Use the specific login endpoints
- **2a. Login - Test User 1 (Auto)** - Logs in as User 1
- **2b. Login - Test User 2 (Auto)** - Logs in as User 2

After login, copy the returned token and update the `token` variable in your environment.

### Option 2: Update environment variables
Manually update these in your environment:
```json
{
  "user_id": "test-user-002",
  "wallet_address": "0x70997970C51812dc3A010C7d01b50e0d17dc79C8",
  "token": "{{ _.test_user_2_token }}"
}
```

## Testing Workflow Example

### Create a Loan as User 1, Match as User 2

1. Login as Test User 1:
   ```
   POST 2a. Login - Test User 1 (Auto)
   ```

2. Create a loan:
   ```
   POST Create Loan
   - Copy the returned loan_id
   - Update environment: "loan_id": "copied-loan-id"
   ```

3. Login as Test User 2:
   ```
   POST 2b. Login - Test User 2 (Auto)
   - Copy the returned token
   - Update environment: "token": "copied-token"
   ```

4. Match the loan:
   ```
   POST Match Loan
   - Uses the loan_id from step 2
   ```

5. Activate the loan:
   ```
   POST Activate Loan
   ```

## Troubleshooting

### "Authentication request expired"
- Run `npm run seed:test-users` again to generate fresh signatures
- Update your Insomnia environment with the new values

### "Invalid authentication message"
- Make sure you copied the exact message from the seed script output
- Check that wallet_address matches exactly (case-sensitive)
- Verify timestamp matches the message

### "Invalid signature"
- The signature must be generated from the exact message
- Run `npm run seed:test-users` to get a fresh signature

### "Unauthorized" or "Invalid token"
- Your JWT token may have expired (7 days)
- Login again to get a new token
- Update the `token` variable in your environment

### Database Connection Errors
- Make sure PostgreSQL is running
- Check your `.env` file for correct database credentials
- Run `npm run seed` to ensure basic assets are seeded

## Manual Testing (Advanced)

If you want to test with your own wallet instead of the test users, see [TESTING.md](./TESTING.md) for detailed instructions.

## Security Notes

‚ö†Ô∏è **Important Security Reminders:**
1. The test private keys are **publicly known** - NEVER use them on mainnet
2. These test accounts are from Hardhat's default mnemonic
3. Only use these for local development and testing
4. In production, users will connect their own wallets (MetaMask, etc.)
