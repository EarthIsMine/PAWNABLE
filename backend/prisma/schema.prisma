// Prisma Schema for PAWNABLE
// Base Sepolia Testnet (chain_id = 84532)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================
// USERS
// =========================
model User {
  address    String   @id @db.VarChar(42) // 0x... EOA address
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  loanRequests     LoanRequest[] @relation("BorrowerRequests")
  borrowedLoans    Loan[]        @relation("BorrowerLoans")
  lendedLoans      Loan[]        @relation("LenderLoans")

  @@map("users")
}

// =========================
// TOKENS
// =========================
model Token {
  chainId    Int      @map("chain_id")
  address    String   @db.VarChar(42) // ERC20 address or 0x0 for native
  symbol     String   @db.VarChar(20)
  decimals   Int
  isNative   Boolean  @default(false) @map("is_native")
  isAllowed  Boolean  @default(true) @map("is_allowed")
  indexedAt  DateTime @default(now()) @map("indexed_at")

  // Relations
  requestsAsCollateral LoanRequest[] @relation("CollateralToken")
  requestsAsPrincipal  LoanRequest[] @relation("PrincipalToken")

  @@id([chainId, address])
  @@index([isAllowed])
  @@map("tokens")
}

// =========================
// LOAN REQUESTS (on-chain order book)
// =========================
model LoanRequest {
  id                     String   @id @default(uuid()) @db.Uuid

  // Chain & Contract
  chainId                Int      @map("chain_id")
  contractAddress        String   @map("contract_address") @db.VarChar(42)
  onchainRequestId       Decimal  @map("onchain_request_id") @db.Decimal(78, 0)

  // Borrower
  borrowerAddress        String   @map("borrower_address") @db.VarChar(42)

  // Collateral
  collateralTokenAddress String   @map("collateral_token_address") @db.VarChar(42)
  collateralAmount       Decimal  @map("collateral_amount") @db.Decimal(78, 0)

  // Principal
  principalTokenAddress  String   @map("principal_token_address") @db.VarChar(42)
  principalAmount        Decimal  @map("principal_amount") @db.Decimal(78, 0)

  // Loan Terms
  interestBps            Int      @map("interest_bps")
  durationSeconds        Int      @map("duration_seconds")

  // Status: OPEN | FUNDED | CANCELLED
  status                 String   @db.VarChar(20)

  // Transaction Hashes
  createTxHash           String   @map("create_tx_hash") @db.VarChar(66)
  cancelTxHash           String?  @map("cancel_tx_hash") @db.VarChar(66)

  // Indexer Metadata
  createdAtBlock         BigInt   @map("created_at_block")
  indexedAt              DateTime @default(now()) @map("indexed_at")

  // Relations
  borrower               User    @relation("BorrowerRequests", fields: [borrowerAddress], references: [address])
  collateralToken        Token   @relation("CollateralToken", fields: [chainId, collateralTokenAddress], references: [chainId, address])
  principalToken         Token   @relation("PrincipalToken", fields: [chainId, principalTokenAddress], references: [chainId, address])
  loan                   Loan?

  @@unique([chainId, contractAddress, onchainRequestId])
  @@index([status])
  @@index([borrowerAddress])
  @@index([chainId, status])
  @@map("loan_requests")
}

// =========================
// LOANS (on-chain indexed)
// =========================
model Loan {
  id                String   @id @default(uuid()) @db.Uuid

  // Chain & Contract
  chainId           Int      @map("chain_id")
  contractAddress   String   @map("contract_address") @db.VarChar(42)
  onchainLoanId     Decimal  @map("onchain_loan_id") @db.Decimal(78, 0)

  // Request Reference
  requestId         String?  @unique @map("request_id") @db.Uuid

  // Parties
  borrowerAddress   String   @map("borrower_address") @db.VarChar(42)
  lenderAddress     String   @map("lender_address") @db.VarChar(42)

  // Timestamps
  startTimestamp    BigInt   @map("start_timestamp")
  dueTimestamp      BigInt   @map("due_timestamp")

  // Status: ONGOING | REPAID | CLAIMED
  status            String   @db.VarChar(20)

  // Transaction Hashes
  fundTxHash        String   @map("fund_tx_hash") @db.VarChar(66)
  repayTxHash       String?  @map("repay_tx_hash") @db.VarChar(66)
  claimTxHash       String?  @map("claim_tx_hash") @db.VarChar(66)

  // Indexer Metadata
  indexedAt         DateTime @default(now()) @map("indexed_at")

  // Relations
  request           LoanRequest? @relation(fields: [requestId], references: [id])
  borrower          User         @relation("BorrowerLoans", fields: [borrowerAddress], references: [address])
  lender            User         @relation("LenderLoans", fields: [lenderAddress], references: [address])

  @@unique([chainId, onchainLoanId])
  @@index([status])
  @@index([borrowerAddress])
  @@index([lenderAddress])
  @@index([dueTimestamp, status])
  @@map("loans")
}
