name: Deploy (EC2)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.26.2
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm -r build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            set -e
            cd "$APP_DIR"
            git fetch --all
            git reset --hard origin/main
            if [ -n "$FRONTEND_ENV" ]; then
              printf "%s" "$FRONTEND_ENV" > frontend/.env
            fi
            if [ -n "$BACKEND_ENV" ]; then
              printf "%s" "$BACKEND_ENV" > backend/.env
            fi
            pnpm install --frozen-lockfile
            pnpm -r build
            pnpm --filter pawnable-backend prisma:generate
            pnpm --filter pawnable-backend exec prisma migrate deploy
            pm2 startOrReload ecosystem.config.js
        env:
          APP_DIR: ${{ secrets.EC2_APP_DIR }}
          FRONTEND_ENV: ${{ secrets.FRONTEND_ENV }}
          BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
